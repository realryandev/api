const express=require("express"),cors=require("cors"),https=require("https"),fs=require("fs"),path=require("path"),{exec}=require("child_process"),ffmpegPath=require("ffmpeg-static"),{v4:uuidv4}=require("uuid");const app=express();app.use(cors({origin:"https://youtube2-mp3-tool.vercel.app",methods:["POST"],allowedHeaders:["Content-Type"]})),app.use(express.json());const clean=t=>t.replace(/[\\/:*?"<>|]+/g,"_").slice(0,200),getHTML=url=>new Promise((r,j)=>{https.get(url,res=>{let d="";res.on("data",c=>d+=c),res.on("end",()=>r(d))}).on("error",j)}),getAudioURL=html=>{const j=html.match(/ytInitialPlayerResponse\s*=\s*(\{.+?\});/);if(!j)return null;const p=JSON.parse(j[1]);return p.streamingData?.adaptiveFormats?.find(f=>f.mimeType?.includes("audio"))?.url||null},getThumbnail=id=>[`https://i.ytimg.com/vi/${id}/maxresdefault.jpg`,`https://i.ytimg.com/vi/${id}/hqdefault.jpg`],dlFile=(u,d)=>new Promise((r,j)=>{const f=fs.createWriteStream(d);https.get(u,res=>{res.pipe(f),f.on("finish",()=>f.close(()=>r()))}).on("error",e=>fs.unlink(d,()=>j(e)))});app.post("/api/download",async(req,res)=>{let tmpAudio,tmpMP3,tmpThumb;try{const{url}=req.body;if(!url||!url.includes("youtube.com"))return res.status(400).json({error:"Invalid YouTube URL"});const id=new URL(url).searchParams.get("v"),html=await getHTML(url),audioURL=getAudioURL(html);if(!audioURL)throw"Audio not found";const title=clean((html.match(/<title>(.*?)<\/title>/)?.[1]||"audio").replace(" - YouTube",""));tmpAudio=path.join(__dirname,uuidv4()+".webm"),tmpMP3=path.join(__dirname,uuidv4()+".mp3");await dlFile(audioURL,tmpAudio);const thumbs=getThumbnail(id);for(const t of thumbs){tmpThumb=path.join(__dirname,uuidv4()+".jpg");try{await dlFile(t,tmpThumb);if(fs.existsSync(tmpThumb))break}catch{}tmpThumb=null}const cmd=`"${ffmpegPath}" -i "${tmpAudio}"${tmpThumb?` -i "${tmpThumb}" -map 0:a -map 1 -c:v mjpeg -metadata:s:v title="Album cover" -metadata:s:v comment="Cover (front)" -disposition:v attached_pic`:""} -metadata title="${title}" -b:a 192k "${tmpMP3}"`;exec(cmd,err=>{if(err)return res.status(500).json({error:"FFmpeg failed"});res.download(tmpMP3,`${title}.mp3`,e=>{[tmpAudio,tmpMP3,tmpThumb].forEach(f=>f&&fs.existsSync(f)&&fs.unlink(f,()=>{}))})})}catch(e){console.error("❌",e);if(!res.headersSent)res.status(500).json({error:"Failed to process audio"});[tmpAudio,tmpMP3,tmpThumb].forEach(f=>f&&fs.existsSync(f)&&fs.unlinkSync(f))}});app.listen(process.env.PORT||8080,()=>console.log("✅ Server up"));
