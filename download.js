const {writeFileSync,createWriteStream,unlinkSync,existsSync}=require("fs"),{join}=require("path"),express=require("express"),cors=require("cors"),{fetch}=require("undici"),{exec}=require("child_process"),ffmpegPath=require("ffmpeg-static"),{v4:uuid}=require("uuid");const app=express();app.use(cors({origin:"https://youtube2-mp3-tool.vercel.app",methods:["POST"],allowedHeaders:["Content-Type"]})),app.use(express.json());const AGENTS=["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0 Safari/537.36","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.1 Safari/605.1.15","Mozilla/5.0 (Linux; Android 10; SM-G973F) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0 Safari/537.36"],rndUA=_=>AGENTS[Math.floor(Math.random()*AGENTS.length)],clean=t=>t.replace(/[\\/:*?"<>|]+/g,"_").slice(0,200);const dl=(u,d)=>new Promise((r,j)=>{const f=createWriteStream(d);fetch(u,{timeout:20000}).then(rsp=>{if(rsp.status!==200)throw"DL failed";rsp.body.pipe(f).on("finish",r).on("error",j)}).catch(j)});app.post("/api/download",async(req,res)=>{let ta,tm,tt;try{const{url}=req.body;if(!url?.includes("youtube.com"))return res.status(400).json({error:"Invalid URL"});const vid=new URL(url).searchParams.get("v"),html=await fetch(url,{headers:{"user-agent":rndUA(),"accept-language":"en-US,en;q=0.9"},timeout:15000}).then(r=>r.text()),m=html.match(/ytInitialPlayerResponse\s*=\s*(\{.+?\});/);if(!m)throw"Parse error";const js=JSON.parse(m[1]),aud=js.streamingData?.adaptiveFormats?.find(f=>f.mimeType.includes("audio"))?.url;if(!aud)throw"No audio";const title=clean(js.videoDetails?.title||vid);ta=`${uuid()}.webm`,tm=`${uuid()}.mp3`;await dl(aud,ta);for(const q of[`https://i.ytimg.com/vi/${vid}/maxresdefault.jpg`,`https://i.ytimg.com/vi/${vid}/hqdefault.jpg`]){tt=`${uuid()}.jpg`;try{await dl(q,tt);if(existsSync(tt))break}catch{tt=null}};const cmd=`"${ffmpegPath}" -i "${ta}"${tt?` -i "${tt}" -map 0:a -map 1 -c:v mjpeg -metadata:s:v title="Cover" -metadata:s:v comment="Cover (front)" -disposition:v attached_pic`:``} -metadata title="${title}" -b:a 192k "${tm}"`;await new Promise((r,j)=>exec(cmd,(e)=>e?j(e):r()));res.download(tm,`${title}.mp3`,e=>{[ta,tm,tt].forEach(f=>f&&existsSync(f)&&unlinkSync(f))});}catch(e){console.error(e);if(!res.headersSent)res.status(500).json({error:e.toString()});[ta,tm,tt].forEach(f=>f&&existsSync(f)&&unlinkSync(f))}});app.listen(process.env.PORT||8080,()=>console.log("âœ… up"));
